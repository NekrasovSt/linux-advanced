- name: Install packages
  dnf:
    name: '{{ item }}'
    state: present
    disable_gpg_check: yes
  loop:
    - http://mirror.centos.org/centos/7/extras/x86_64/Packages/etcd-3.3.11-2.el7.centos.x86_64.rpm
    - epel-release
    - haproxy
    - postgresql
    - libselinux-python3
    - libsemanage-python3
      
- name: Selinux policy
#  shell: setsebool -P haproxy_connect_any 1
  seboolean:
    name: haproxy_connect_any
    state: yes
    persistent: yes
    
- name: Copy etcd.conf
  template:
    src: etcd.conf.j2
    dest: /etc/etcd/etcd.conf
  notify: restart etcd


- name: copy config
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: root
    group: root
    mode: '0644'
  loop:
    - { src: 'haproxy.cfg', dest: '/etc/haproxy/' }
    - { src: 'init.sql', dest: '/home/vagrant/' }
  notify:
    - restart haproxy

- name: start haproxy
  systemd:
    name: haproxy
    state: started
    enabled: yes        